# Block common exploits for nginx-proxy-guard
# Based on OWASP recommendations
# Sets $block_reason_var = "exploit_block" when blocking
# Sets $exploit_rule_var to specific rule ID for logging

# Initialize variable (will be set by matching rules)
set $exploit_rule_var "-";

# =============================================================================
# SQL INJECTION PROTECTION
# =============================================================================

# SQLI-001: Block union select attacks
if ($query_string ~* "union.*select") {
    set $block_reason_var "exploit_block";
    set $exploit_rule_var "SQLI-001";
    return 403;
}

# SQLI-002: Block concat attacks
if ($query_string ~* "concat.*\(") {
    set $block_reason_var "exploit_block";
    set $exploit_rule_var "SQLI-002";
    return 403;
}

# SQLI-003: Block special characters in query string
if ($query_string ~* "(;|<|>|'|\"|\)|%0A|%0D|%22|%27|%3C|%3E|%00)") {
    set $block_reason_var "exploit_block";
    set $exploit_rule_var "SQLI-003";
    return 403;
}

# =============================================================================
# FILE INJECTION / PATH TRAVERSAL PROTECTION
# =============================================================================

# RFI-001: Block remote file inclusion attempts
# Skip this check for certain legitimate API paths
set $rfi_block 0;
if ($query_string ~* "[a-zA-Z0-9_]=https?://") {
    set $rfi_block 1;
}
# Allow /api/v1/challenge/ path (used for geo restriction challenge)
if ($request_uri ~* "^/api/v1/challenge/") {
    set $rfi_block 0;
}
# Allow WordPress oEmbed API (legitimate use of URL parameter)
if ($request_uri ~* "^/wp-json/oembed/") {
    set $rfi_block 0;
}
# Allow WordPress REST API with URL parameters (many plugins use URL params)
if ($request_uri ~* "^/wp-json/") {
    set $rfi_block 0;
}
if ($rfi_block = 1) {
    set $block_reason_var "exploit_block";
    set $exploit_rule_var "RFI-001";
    return 403;
}

# LFI-001: Block local file inclusion with path parameter
if ($query_string ~* "[a-zA-Z0-9_]=(\.\./)+") {
    set $block_reason_var "exploit_block";
    set $exploit_rule_var "LFI-001";
    return 403;
}

# LFI-002: Block path traversal attempts
if ($query_string ~* "\.\./") {
    set $block_reason_var "exploit_block";
    set $exploit_rule_var "LFI-002";
    return 403;
}

# =============================================================================
# SCANNER / TOOL DETECTION
# =============================================================================

# SCAN-001: Block common exploit tools and vulnerability scanners
if ($http_user_agent ~* (nikto|sqlmap|dirbuster|nmap|nessus|openvas|w3af|acunetix|havij|appscan|webscarab|webinspect)) {
    set $block_reason_var "exploit_block";
    set $exploit_rule_var "SCAN-001";
    set $bot_category_var "scanner";
    return 403;
}

# =============================================================================
# SUSPICIOUS REQUEST METHODS
# =============================================================================

# METHOD-001: Block non-standard HTTP methods
if ($request_method !~ ^(GET|HEAD|POST|PUT|PATCH|DELETE|OPTIONS)$) {
    set $block_reason_var "exploit_block";
    set $exploit_rule_var "METHOD-001";
    return 405;
}

# =============================================================================
# SENSITIVE FILE ACCESS PROTECTION
# =============================================================================

# FILE-001: Block access to sensitive file extensions
location ~* \.(htaccess|htpasswd|ini|log|sh|sql|conf|bak|old|swp|dist|fla|psd|config)$ {
    set $block_reason_var "exploit_block";
    set $exploit_rule_var "FILE-001";
    return 404;
}

# VCS-001: Block access to version control directories
location ~ /\.(git|svn|hg|bzr|cvs) {
    set $block_reason_var "exploit_block";
    set $exploit_rule_var "VCS-001";
    return 404;
}

# ADMIN-001: Block access to common sensitive admin directories
location ~* /(phpmyadmin|myadmin|mysqladmin|administrator|admin/config)(/|$) {
    set $block_reason_var "exploit_block";
    set $exploit_rule_var "ADMIN-001";
    return 404;
}

# WP-001: Block PHP execution in WordPress upload directory
location ~* /wp-content/uploads/.*\.php$ {
    set $block_reason_var "exploit_block";
    set $exploit_rule_var "WP-001";
    return 404;
}

# DB-001: Block direct database admin path access
location ~* ^/mysql(/|$) {
    set $block_reason_var "exploit_block";
    set $exploit_rule_var "DB-001";
    return 404;
}

# BACKUP-001: Block access to backup files
location ~* \.(bak|backup|old|orig|original|save|saved|tmp|temp)$ {
    set $block_reason_var "exploit_block";
    set $exploit_rule_var "BACKUP-001";
    return 404;
}

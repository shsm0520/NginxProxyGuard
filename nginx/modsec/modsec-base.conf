# nginx-proxy-guard ModSecurity Base Configuration
# Common settings for both detection and blocking modes
# SecRuleEngine is set by detection-only.conf or main.conf

# Request body handling
SecRequestBodyAccess On
SecRequestBodyLimit 13107200
SecRequestBodyNoFilesLimit 131072
SecRequestBodyLimitAction ProcessPartial
SecRequestBodyJsonDepthLimit 512

# Response body handling
SecResponseBodyAccess On
SecResponseBodyMimeType text/plain text/html text/xml application/json
SecResponseBodyLimit 1048576
SecResponseBodyLimitAction ProcessPartial

# Audit logging - output to stdout for docker logs
SecAuditEngine RelevantOnly
SecAuditLogRelevantStatus "^(?:5|4(?!04))"
SecAuditLogParts ABIJDEFHZ
SecAuditLogType Serial
SecAuditLog /dev/stdout
SecAuditLogFormat JSON

# Debug log (disabled in production)
SecDebugLog /dev/null
SecDebugLogLevel 0

# Temp and data directories
SecTmpDir /tmp/modsecurity/tmp
SecDataDir /tmp/modsecurity/data

# Other settings
SecArgumentSeparator &
SecArgumentsLimit 1000
SecCookieFormat 0
SecPcreMatchLimit 100000
SecPcreMatchLimitRecursion 100000
SecUnicodeMapFile /etc/nginx/modsec/unicode.mapping 20127
SecStatusEngine Off

# Upload settings
SecTmpSaveUploadedFiles On
SecUploadDir /tmp/modsecurity/upload
SecUploadFileMode 0600
SecUploadKeepFiles Off

# Request body processors
SecRule REQUEST_HEADERS:Content-Type "^(?:application(?:/soap\+|/)|text/)xml" \
    "id:200000,phase:1,t:none,t:lowercase,pass,nolog,ctl:requestBodyProcessor=XML"

SecRule REQUEST_HEADERS:Content-Type "^application/json" \
    "id:200001,phase:1,t:none,t:lowercase,pass,nolog,ctl:requestBodyProcessor=JSON"

SecRule &ARGS "@ge 1000" \
    "id:200007,phase:2,t:none,log,deny,status:403,msg:'Failed to fully parse request body due to large argument count',severity:2"

SecRule REQBODY_ERROR "!@eq 0" \
    "id:200002,phase:2,t:none,log,deny,status:403,msg:'Failed to parse request body.',logdata:'%{reqbody_error_msg}',severity:2"

SecRule MULTIPART_STRICT_ERROR "!@eq 0" \
    "id:200003,phase:2,t:none,log,deny,status:403,msg:'Multipart request body failed strict validation'"

SecRule MULTIPART_UNMATCHED_BOUNDARY "!@eq 0" \
    "id:200004,phase:2,t:none,log,deny,status:403,msg:'Multipart parser detected a possible unmatched boundary'"

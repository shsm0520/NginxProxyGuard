package model

import "time"

// ExploitBlockRule represents a database-managed exploit blocking rule
type ExploitBlockRule struct {
	ID          string    `json:"id" db:"id"`
	Category    string    `json:"category" db:"category"`           // sql_injection, xss, rfi, path_traversal, scanner, http_method
	Name        string    `json:"name" db:"name"`
	Pattern     string    `json:"pattern" db:"pattern"`             // Regex pattern for nginx
	PatternType string    `json:"pattern_type" db:"pattern_type"`   // query_string, request_uri, user_agent, request_method
	Description string    `json:"description" db:"description"`
	Severity    string    `json:"severity" db:"severity"`           // info, warning, critical
	Enabled     bool      `json:"enabled" db:"enabled"`
	IsSystem    bool      `json:"is_system" db:"is_system"`         // System rules cannot be deleted
	SortOrder   int       `json:"sort_order" db:"sort_order"`
	CreatedAt   time.Time `json:"created_at" db:"created_at"`
	UpdatedAt   time.Time `json:"updated_at" db:"updated_at"`
}

// GlobalExploitRuleExclusion represents a globally disabled exploit rule
type GlobalExploitRuleExclusion struct {
	ID         string    `json:"id" db:"id"`
	RuleID     string    `json:"rule_id" db:"rule_id"`
	Reason     string    `json:"reason,omitempty" db:"reason"`
	DisabledBy string    `json:"disabled_by,omitempty" db:"disabled_by"`
	CreatedAt  time.Time `json:"created_at" db:"created_at"`
}

// HostExploitRuleExclusion represents a per-host disabled exploit rule
type HostExploitRuleExclusion struct {
	ID          string    `json:"id" db:"id"`
	ProxyHostID string    `json:"proxy_host_id" db:"proxy_host_id"`
	RuleID      string    `json:"rule_id" db:"rule_id"`
	Reason      string    `json:"reason,omitempty" db:"reason"`
	DisabledBy  string    `json:"disabled_by,omitempty" db:"disabled_by"`
	CreatedAt   time.Time `json:"created_at" db:"created_at"`
}

// ExploitBlockRuleCategory groups rules by category for UI display
type ExploitBlockRuleCategory struct {
	ID          string                     `json:"id"`
	Name        string                     `json:"name"`
	Description string                     `json:"description"`
	RuleCount   int                        `json:"rule_count"`
	Rules       []ExploitBlockRuleWithStatus `json:"rules,omitempty"`
}

// ExploitBlockRuleWithStatus includes rule with exclusion status for a specific context
type ExploitBlockRuleWithStatus struct {
	ExploitBlockRule
	GloballyDisabled bool                        `json:"globally_disabled"`
	HostDisabled     bool                        `json:"host_disabled,omitempty"`
	Exclusion        *HostExploitRuleExclusion   `json:"exclusion,omitempty"`
	GlobalExclusion  *GlobalExploitRuleExclusion `json:"global_exclusion,omitempty"`
}

// ExploitRulesResponse is the API response for exploit rules listing
type ExploitRulesResponse struct {
	Categories       []ExploitBlockRuleCategory `json:"categories"`
	TotalRules       int                        `json:"total_rules"`
	GlobalExclusions []GlobalExploitRuleExclusion `json:"global_exclusions,omitempty"`
}

// ExploitRuleHostConfig represents a host's exploit blocking configuration
type ExploitRuleHostConfig struct {
	ProxyHostID    string `json:"proxy_host_id"`
	ProxyHostName  string `json:"proxy_host_name"`
	BlockExploits  bool   `json:"block_exploits"`
	ExclusionCount int    `json:"exclusion_count"`
}

// ExploitRuleHostsResponse is the API response for hosts with exploit blocking
type ExploitRuleHostsResponse struct {
	Hosts []ExploitRuleHostConfig `json:"hosts"`
	Total int                     `json:"total"`
}

// DisableExploitRuleRequest is the request to disable an exploit rule
type DisableExploitRuleRequest struct {
	RuleID      string `json:"rule_id"`
	Reason      string `json:"reason,omitempty"`
}

// CreateExploitRuleRequest is the request to create a custom exploit rule
type CreateExploitRuleRequest struct {
	Category    string `json:"category" validate:"required,oneof=sql_injection xss rfi path_traversal scanner http_method custom"`
	Name        string `json:"name" validate:"required,max=100"`
	Pattern     string `json:"pattern" validate:"required"`
	PatternType string `json:"pattern_type" validate:"required,oneof=query_string request_uri user_agent request_method"`
	Description string `json:"description"`
	Severity    string `json:"severity" validate:"oneof=info warning critical"`
}

// UpdateExploitRuleRequest is the request to update an exploit rule
type UpdateExploitRuleRequest struct {
	Name        *string `json:"name,omitempty"`
	Pattern     *string `json:"pattern,omitempty"`
	PatternType *string `json:"pattern_type,omitempty"`
	Description *string `json:"description,omitempty"`
	Severity    *string `json:"severity,omitempty"`
	Enabled     *bool   `json:"enabled,omitempty"`
}

// Category name mapping
var ExploitRuleCategoryNames = map[string]string{
	"sql_injection":   "SQL Injection",
	"xss":             "XSS / Code Injection",
	"rfi":             "Remote File Inclusion",
	"path_traversal":  "Path Traversal",
	"scanner":         "Scanner / Tool Detection",
	"http_method":     "HTTP Method",
	"custom":          "Custom Rules",
}

// Category descriptions
var ExploitRuleCategoryDescriptions = map[string]string{
	"sql_injection":   "Blocks SQL injection attempts in query strings",
	"xss":             "Blocks cross-site scripting and code injection",
	"rfi":             "Blocks remote file inclusion attacks",
	"path_traversal":  "Blocks directory traversal attempts",
	"scanner":         "Blocks known security scanners and hacking tools",
	"http_method":     "Blocks dangerous HTTP methods",
	"custom":          "User-defined custom blocking rules",
}
